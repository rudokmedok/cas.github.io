<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RU :: TCP 16-20 DPI Checker | rudokmedok</title>
  <style>
    :root {
      --bg: linear-gradient(to bottom, #0a0a0a, #1a1a1a);
      --card-bg: #222;
      --text: #eee;
      --text-muted: #aaa;
      --accent: #fff;
      --success: #4ade80;
      --warning: #fbbf24;
      --error: #f87171;
      --info: #60a5fa;
      --border: #333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font: 1em/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 2.2em;
      font-weight: 800;
      background: linear-gradient(90deg, #ffffff, #cccccc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 8px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .tab-btn {
      padding: 10px 20px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: #333;
      border-color: #555;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .server-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
      margin: 15px 0;
    }

    .server-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .server-item input {
      margin: 0;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }

    #start {
      font-size: 1.2em;
      padding: 0.8em 1.5em;
      background: #ff008b;
      color: #fff;
      border: 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
    }

    #start:hover {
      background: #d40074;
      transform: translateY(-2px);
    }

    #start:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }

    #status {
      font-weight: 600;
    }

    .status-ready { color: var(--success); }
    .status-checking { color: var(--info); }
    .status-error { color: var(--error); }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 0.2em;
      margin-bottom: 20px;
    }

    th, td {
      padding: 8px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: #333;
      font-weight: 600;
    }

    tr:last-child td {
      border-bottom: 0;
    }

    .ok { color: var(--success); font-weight: 500; }
    .bad { color: var(--error); font-weight: 500; }

    #log {
      background: #000;
      color: #ccc;
      padding: 15px;
      border-radius: 6px;
      font: 0.9em 'Courier New', monospace;
      max-height: 250px;
      overflow-y: auto;
      margin: 0.5em 0;
      white-space: pre-wrap;
    }

    #asn {
      margin-top: 0.2em;
      font-size: 0.9em;
      color: var(--text-muted);
    }

    .footer {
      margin-top: 30px;
      font-size: 0.9em;
      color: var(--text-muted);
      text-align: center;
    }

    a {
      color: var(--info);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      .logo { font-size: 1.8em; }
      .server-list { grid-template-columns: 1fr; }
      #start { width: 100%; font-size: 1em; }
      th, td { padding: 6px 10px; font-size: 0.9em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">rudokmedok</div>
      <div id="asn"></div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="games">–ò–≥—Ä–æ–≤—ã–µ</button>
      <button class="tab-btn" data-tab="discord">Discord</button>
      <button class="tab-btn" data-tab="youtube">YouTube / RKN</button>
      <button class="tab-btn" data-tab="all">–í—Å–µ</button>
    </div>

    <!-- –ò–≥—Ä–æ–≤—ã–µ -->
    <div class="tab-content active" id="tab-games">
      <div class="server-list" id="list-games"></div>
    </div>

    <!-- Discord -->
    <div class="tab-content" id="tab-discord">
      <div class="server-list" id="list-discord"></div>
    </div>

    <!-- YouTube / RKN -->
    <div class="tab-content" id="tab-youtube">
      <div class="server-list" id="list-youtube"></div>
    </div>

    <!-- –í—Å–µ -->
    <div class="tab-content" id="tab-all">
      <div class="server-list" id="list-all"></div>
    </div>

    <div class="controls">
      <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
      <span>–°—Ç–∞—Ç—É—Å: <span id="status" class="status-ready">–ì–æ—Ç–æ–≤ ‚ö°</span></span>
    </div>

    <table id="results">
      <tr>
        <th>#</th>
        <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
        <th>–°—Ç–∞—Ç—É—Å DPI[tcp 16-20]</th>
      </tr>
    </table>

    <pre id="log"></pre>

    <div class="footer">
      üí° DPI[tcp 16-20] ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ö–æ–¥–∞ DPI –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ TCP 16‚Äì20 –±–∞–π—Ç.<br>
      –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <a href="https://github.com/net4people/bbs/issues/490" target="_blank">–∑–¥–µ—Å—å</a>.<br>
      –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: <a href="https://github.com/hyperion-cs/dpi-checkers" target="_blank">dpi-checkers</a>.
    </div>
  </div>

  <script>
    // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const OK_THRESHOLD_BYTES = 64 * 1024;
    let TIMEOUT_MS = 5000;

    // –í—Å–µ —Ç–µ—Å—Ç—ã
    const FULL_TEST_SUITE = [
      { id: "US.CF-01", provider: "üá∫üá∏ Cloudflare", group: "games", url: "https://cdn.cookielaw.org/scripttemplates/202501.2.0/otBannerSdk.js" },
      { id: "US.CF-02", provider: "üá∫üá∏ Cloudflare", group: "games", url: "https://genshin.jmp.blue/characters/all#" },
      { id: "US.CF-03", provider: "üá∫üá∏ Cloudflare", group: "games", url: "https://api.frankfurter.dev/v1/2000-01-01..2002-12-31" },
      { id: "US.DO-01", provider: "üá∫üá∏ DigitalOcean", group: "games", url: "https://genderize.io/" },
      { id: "DE.HE-01", provider: "üá©üá™ Hetzner", group: "games", url: "https://j.dejure.org/jcg/doctrine/doctrine_banner.webp" },
      { id: "FI.HE-01", provider: "üá´üáÆ Hetzner", group: "games", url: "https://tcp1620-01.dubybot.live/1MB.bin" },
      { id: "FI.HE-02", provider: "üá´üáÆ Hetzner", group: "games", url: "https://tcp1620-02.dubybot.live/1MB.bin" },
      { id: "FI.HE-03", provider: "üá´üáÆ Hetzner", group: "games", url: "https://tcp1620-05.dubybot.live/1MB.bin" },
      { id: "FI.HE-04", provider: "üá´üáÆ Hetzner", group: "games", url: "https://tcp1620-06.dubybot.live/1MB.bin" },
      { id: "FR.OVH-01", provider: "üá´üá∑ OVH", group: "games", url: "https://eu.api.ovh.com/console/rapidoc-min.js" },
      { id: "FR.OVH-02", provider: "üá´üá∑ OVH", group: "games", url: "https://ovh.sfx.ovh/10M.bin" },
      { id: "SE.OR-01", provider: "üá∏üá™ Oracle", group: "games", url: "https://oracle.sfx.ovh/10M.bin" },

      // Discord
      { id: "DISC-01", provider: "üåç Discord CDN", group: "discord", url: "https://cdn.discordapp.com/attachments/1234567890/1234567890/image.png" },
      { id: "DISC-02", provider: "üåç Discord API", group: "discord", url: "https://discord.com/api/v9/gateway" },

    ];

    // –î—É–±–ª–∏—Ä—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ —Ç–µ—Å—Ç—ã –∏–∑ –≤–æ–ø—Ä–æ—Å–∞ (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–ø–ø)
    const LEGACY_SUITE = [
      { id: "DE.AWS-01", provider: "üá©üá™ AWS", group: "games", url: "https://tms.delta.com/delta/dl_anderson/Bootstrap.js" },
      { id: "US.AWS-01", provider: "üá∫üá∏ AWS", group: "games", url: "https://corp.kaltura.com/wp-content/cache/min/1/wp-content/themes/airfleet/dist/styles/theme.css" },
      { id: "US.GC-01", provider: "üá∫üá∏ Google Cloud", group: "games", url: "https://api.usercentrics.eu/gvl/v3/en.json" },
      { id: "US.FST-01", provider: "üá∫üá∏ Fastly", group: "games", url: "https://openoffice.apache.org/images/blog/rejected.png" },
      { id: "US.FST-02", provider: "üá∫üá∏ Fastly", group: "games", url: "https://www.juniper.net/etc.clientlibs/juniper/clientlibs/clientlib-site/resources/fonts/lato/Lato-Regular.woff2" },
      { id: "PL.AKM-01", provider: "üáµüá± Akamai", group: "games", url: "https://www.lg.com/lg5-common-gp/library/jquery.min.js" },
      { id: "PL.AKM-02", provider: "üáµüá± Akamai", group: "games", url: "https://media-assets.stryker.com/is/image/stryker/gateway_1?$max_width_1410$" },
      { id: "US.CDN77-01", provider: "üá∫üá∏ CDN77", group: "games", url: "https://www.winkgo.com/wp-content/themes/mts_sociallyviral/fonts/fontawesome-webfont.woff2" },
      { id: "DE.CNTB-01", provider: "üá©üá™ Contabo", group: "games", url: "https://cloudlets.io/wp-content/themes/Avada/includes/lib/assets/fonts/fontawesome/webfonts/fa-solid-900.woff2" },
      { id: "FR.SW-01", provider: "üá´üá∑ Scaleway", group: "games", url: "https://renklisigorta.com.tr/teklif-al" },
      { id: "US.CNST-01", provider: "üá∫üá∏ Constant", group: "games", url: "https://cdn.xuansiwei.com/common/lib/font-awesome/4.7.0/fontawesome-webfont.woff2?v=4.7.0" }
    ];

    const TEST_SUITE = [...FULL_TEST_SUITE, ...LEGACY_SUITE];

    // –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞
    const groups = {
      games: TEST_SUITE.filter(t => t.group === 'games'),
      discord: TEST_SUITE.filter(t => t.group === 'discord'),
      youtube: TEST_SUITE.filter(t => t.group === 'youtube'),
      all: TEST_SUITE
    };

    // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
    const startButton = document.getElementById("start");
    const statusEl = document.getElementById("status");
    const log = document.getElementById("log");
    const results = document.getElementById("results");
    const httpCodes = {};

    // –í–∫–ª–∞–¥–∫–∏
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        const tabId = btn.dataset.tab;
        document.getElementById(`tab-${tabId}`).classList.add('active');
        localStorage.setItem('activeTab', tabId);
      });
    });

    // –†–µ–Ω–¥–µ—Ä —á–µ–∫–±–æ–∫—Å–æ–≤
    function renderCheckboxes(containerId, tests) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      tests.forEach(test => {
        const div = document.createElement('div');
        div.className = 'server-item';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = `chk-${test.id}`;
        input.dataset.testId = test.id;
        input.checked = localStorage.getItem(`test-${test.id}`) !== 'false'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ
        input.addEventListener('change', () => {
          localStorage.setItem(`test-${test.id}`, input.checked);
        });
        const label = document.createElement('label');
        label.htmlFor = `chk-${test.id}`;
        label.textContent = `${test.provider} (${test.id})`;
        div.appendChild(input);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤–∫–ª–∞–¥–∫–∏ –∏–∑ localStorage
    const savedTab = localStorage.getItem('activeTab') || 'games';
    document.querySelectorAll('.tab-btn').forEach(btn => {
      if (btn.dataset.tab === savedTab) {
        btn.click();
      }
    });

    // –†–µ–Ω–¥–µ—Ä –≤—Å–µ—Ö —Å–ø–∏—Å–∫–æ–≤
    Object.entries(groups).forEach(([key, tests]) => {
      renderCheckboxes(`list-${key}`, tests);
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
    function getSelectedTests() {
      return TEST_SUITE.filter(test => {
        return localStorage.getItem(`test-${test.id}`) !== 'false';
      });
    }

    // UI
    const toggleUI = (locked) => {
      startButton.disabled = locked;
      startButton.textContent = locked ? "–ü—Ä–æ–≤–µ—Ä–∫–∞..." : "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É";
      statusEl.className = locked ? "status-checking" : "status-ready";
    };

    const setStatus = (col, text, cls) => {
      col.textContent = text;
      col.className = cls;
      if (cls === "bad") statusEl.className = "status-error";
    };

    const logPush = (level, prefix, msg) => {
      const now = new Date();
      const ts = now.toLocaleTimeString([], { hour12: false }) + "." + now.getMilliseconds().toString().padStart(3, "0");
      log.textContent += `[${ts}] ${prefix ? prefix + "/" : ""}${level}: ${msg}\n`;
      log.scrollTop = log.scrollHeight;
    };

    const timeElapsed = t0 => `${(performance.now() - t0).toFixed(1)} –º—Å`;

    const getHttpStatus = id => httpCodes[id];

    const getUniqueUrl = url => {
      return url.includes('?') ? `${url}&t=${Math.random()}` : `${url}?t=${Math.random()}`;
    };

    // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏
    const startOrchestrator = async () => {
      statusEl.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞ ‚è∞";
      statusEl.className = "status-checking";
      while (results.rows.length > 1) results.deleteRow(1);

      try {
        const selectedTests = getSelectedTests();
        if (selectedTests.length === 0) {
          logPush("WARN", null, "–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.");
          statusEl.textContent = "–ì–æ—Ç–æ–≤ ‚ö°";
          statusEl.className = "status-ready";
          toggleUI(false);
          return;
        }

        const tasks = [];
        for (let t of selectedTests) {
          tasks.push(checkDpi(t.id, t.provider, t.url));
        }
        await Promise.all(tasks);
        statusEl.textContent = "–ì–æ—Ç–æ–≤ ‚ö°";
        statusEl.className = "status-ready";
      } catch (e) {
        statusEl.textContent = "–û—à–∏–±–∫–∞ ‚ö†Ô∏è";
        logPush("ERR", null, `–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${e}`);
        statusEl.className = "status-error";
      }
      logPush("INFO", null, "–ì–æ—Ç–æ–≤–æ.");
      toggleUI(false);
    };

    const checkDpi = async (id, provider, url) => {
      const prefix = `DPI(#${id})`;
      const t0 = performance.now();
      const ctrl = new AbortController();
      const timeoutId = setTimeout(() => ctrl.abort(), TIMEOUT_MS);
      const row = results.insertRow();
      const numCell = row.insertCell();
      const providerCell = row.insertCell();
      const statusCell = row.insertCell();
      numCell.textContent = id;
      providerCell.textContent = provider;
      setStatus(statusCell, "–ü—Ä–æ–≤–µ—Ä–∫–∞ ‚è∞", "");

      try {
        const r = await fetch(getUniqueUrl(url), {
          method: "GET",
          credentials: "omit",
          cache: "no-store",
          signal: ctrl.signal,
          redirect: "manual",
          keepalive: true
        });
        logPush("INFO", prefix, `HTTP ${r.status}`);
        httpCodes[id] = r.status;
        const reader = r.body.getReader();
        let received = 0, ok = false;
        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            clearTimeout(timeoutId);
            logPush("INFO", prefix, `–ü–æ—Ç–æ–∫ –∑–∞–≤–µ—Ä—à—ë–Ω (${timeElapsed(t0)})`);
            if (!ok) {
              logPush("WARN", prefix, "–î–∞–Ω–Ω—ã—Ö –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è");
              setStatus(statusCell, "–í–æ–∑–º–æ–∂–Ω–æ, –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚ö†Ô∏è", "");
            }
            break;
          }
          received += value.byteLength;
          logPush("INFO", prefix, `–ü–æ–ª—É—á–µ–Ω–æ: ${value.byteLength} –±–∞–π—Ç (–≤—Å–µ–≥–æ: ${received})`);
          if (!ok && received >= OK_THRESHOLD_BYTES) {
            clearTimeout(timeoutId);
            await reader.cancel();
            ok = true;
            logPush("INFO", prefix, `–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ø–æ—Ä–æ–≥ (${timeElapsed(t0)})`);
            setStatus(statusCell, "–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚úÖ", "ok");
            break;
          }
        }
      } catch (e) {
        clearTimeout(timeoutId);
        if (e.name === "AbortError") {
          const statusCode = getHttpStatus(id);
          let reason = statusCode ? "–ß–¢–ï–ù–ò–ï" : "–°–û–ï–î.";
          logPush("ERR", prefix, `${reason} ‚Äî —Ç–∞–π–º–∞—É—Ç (${timeElapsed(t0)})`);
          setStatus(statusCell, statusCode ? "–ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è! ‚ùóÔ∏è" : "–ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è* ‚ùóÔ∏è", "bad");
        } else {
          logPush("ERR", prefix, `–û—à–∏–±–∫–∞: ${e}`);
          setStatus(statusCell, "–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ ‚ö†Ô∏è", "");
        }
      }
    };

    startButton.onclick = () => {
      log.textContent = "";
      toggleUI(true);
      sessionStorage.clear();
      startOrchestrator();
    };

    // ASN
    const fetchAsn = async () => {
      try {
        const RIPE_API_URL = "https://stat.ripe.net/data/";
        const ip = (await (await fetch(RIPE_API_URL + "whats-my-ip/data.json")).json()).data.ip;
        const asn = (await (await fetch(RIPE_API_URL + "prefix-overview/data.json?resource=" + ip)).json()).data.asns[0];
        const geo = (await (await fetch(RIPE_API_URL + "maxmind-geo-lite/data.json?resource=" + ip)).json()).data.located_resources[0].locations[0];
        const el = document.getElementById("asn");
        el.innerHTML = `ASN: <a href="https://bgp.he.net/AS${asn.asn}" target="_blank">AS${asn.asn}</a> (<i>${asn.holder}</i>) ‚Ä¢ ${geo.country}, ${geo.city || "‚Äî"}`;
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ ASN:", err);
      }
    };

    document.addEventListener("DOMContentLoaded", fetchAsn);
  </script>
</body>
</html>
