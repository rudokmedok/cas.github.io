<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RU :: TCP 16-20 DPI Checker | rudokmedok</title>
  <style>
    :root {
      --bg: linear-gradient(to bottom, #0a0a0a, #1a1a1a);
      --card-bg: #222;
      --text: #eee;
      --text-muted: #aaa;
      --accent: #fff;
      --success: #4ade80;
      --warning: #fbbf24;
      --error: #f87171;
      --info: #60a5fa;
      --border: #333;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font: 1em/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      text-align: center;
      margin-bottom: 20px;
    }

    .logo {
      font-size: 2.2em;
      font-weight: 800;
      background: linear-gradient(90deg, #ffffff, #cccccc);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      margin-bottom: 8px;
    }

    .tabs {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin: 20px 0;
    }

    .tab-btn {
      padding: 10px 20px;
      background: var(--card-bg);
      border: 1px solid var(--border);
      color: var(--text);
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: #333;
      border-color: #555;
      font-weight: bold;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .custom-input-area {
      margin: 15px 0;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    #custom-input {
      width: 100%;
      height: 100px;
      padding: 10px;
      background: #111;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: monospace;
      resize: vertical;
    }

    .btn {
      padding: 8px 16px;
      background: #333;
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.95em;
      margin-right: 6px;
      margin-top: 8px;
    }

    .btn:hover {
      background: #444;
    }

    .server-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
      margin: 15px 0;
    }

    .server-item {
      background: var(--card-bg);
      padding: 10px;
      border-radius: 6px;
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .server-item input {
      margin: 0;
    }

    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }

    .btn-group {
      display: flex;
      gap: 8px;
    }

    #start {
      font-size: 1.2em;
      padding: 0.8em 1.5em;
      background: #ff008b;
      color: #fff;
      border: 0;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s, transform 0.1s;
    }

    #start:hover {
      background: #d40074;
      transform: translateY(-2px);
    }

    #start:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }

    #status {
      font-weight: 600;
    }

    .status-ready { color: var(--success); }
    .status-checking { color: var(--info); }
    .status-error { color: var(--error); }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card-bg);
      border-radius: 8px;
      overflow: hidden;
      margin-top: 0.2em;
      margin-bottom: 20px;
    }

    th, td {
      padding: 8px 15px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }

    th {
      background: #333;
      font-weight: 600;
    }

    tr:last-child td {
      border-bottom: 0;
    }

    .ok { color: var(--success); font-weight: 500; }
    .bad { color: var(--error); font-weight: 500; }

    #log {
      background: #000;
      color: #ccc;
      padding: 15px;
      border-radius: 6px;
      font: 0.9em 'Courier New', monospace;
      max-height: 250px;
      overflow-y: auto;
      margin: 0.5em 0;
      white-space: pre-wrap;
    }

    #asn {
      margin-top: 0.2em;
      font-size: 0.9em;
      color: var(--text-muted);
    }

    .footer {
      margin-top: 30px;
      font-size: 0.9em;
      color: var(--text-muted);
      text-align: center;
    }

    a {
      color: var(--info);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    @media (max-width: 600px) {
      .container { padding: 10px; }
      .logo { font-size: 1.8em; }
      .server-list { grid-template-columns: 1fr; }
      #start { width: 100%; font-size: 1em; }
      th, td { padding: 6px 10px; font-size: 0.9em; }
      .controls { flex-direction: column; align-items: stretch; }
      .custom-input-area { padding: 10px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">rudokmedok</div>
      <div id="asn"></div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="games">–ò–≥—Ä–æ–≤—ã–µ</button>
      <button class="tab-btn" data-tab="discord">Discord</button>
      <button class="tab-btn" data-tab="youtube">YouTube / RKN / Google</button>
      <button class="tab-btn" data-tab="cloud">–û–±–ª–∞—á–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã</button>
      <button class="tab-btn" data-tab="custom">–°–≤–æ–∏ —Å–µ—Ä–≤–µ—Ä—ã</button>
    </div>

    <div class="controls">
      <div class="btn-group">
        <button class="btn" id="select-all">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
        <button class="btn" id="deselect-all">–°–Ω—è—Ç—å –≤—Å–µ</button>
      </div>
      <button id="start">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É</button>
      <span>–°—Ç–∞—Ç—É—Å: <span id="status" class="status-ready">–ì–æ—Ç–æ–≤ ‚ö°</span></span>
    </div>

    <!-- –ò–≥—Ä–æ–≤—ã–µ -->
    <div class="tab-content active" id="tab-games">
      <div class="server-list" id="list-games"></div>
    </div>

    <!-- Discord -->
    <div class="tab-content" id="tab-discord">
      <div class="server-list" id="list-discord"></div>
    </div>

    <!-- YouTube / RKN / Google -->
    <div class="tab-content" id="tab-youtube">
      <div class="server-list" id="list-youtube"></div>
    </div>

    <!-- –û–±–ª–∞—á–Ω—ã–µ -->
    <div class="tab-content" id="tab-cloud">
      <div class="server-list" id="list-cloud"></div>
    </div>

    <!-- –°–≤–æ–∏ -->
    <div class="tab-content" id="tab-custom">
      <div class="custom-input-area">
        <textarea id="custom-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –¥–æ–º–µ–Ω—ã –∏–ª–∏ URL (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏ –∏–ª–∏ –¥–≤–æ–µ—Ç–æ—á–∏–µ):&#10;example.com&#10;https://test.ru, api.service.net:sub.domain.org"></textarea><br>
        <button class="btn" id="add-custom">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä—ã</button>
        <button class="btn" id="clear-custom">–û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>
      <div class="server-list" id="list-custom"></div>
    </div>

    <table id="results">
      <tr>
        <th>#</th>
        <th>–ü—Ä–æ–≤–∞–π–¥–µ—Ä</th>
        <th>–°—Ç–∞—Ç—É—Å DPI[tcp 16-20]</th>
      </tr>
    </table>

    <pre id="log"></pre>

    <div class="footer">
      üí° DPI[tcp 16-20] ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ–±—Ö–æ–¥–∞ DPI –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ TCP 16‚Äì20 –±–∞–π—Ç.<br>
      –ü–æ–¥—Ä–æ–±–Ω–µ–µ: <a href="https://github.com/net4people/bbs/issues/490" target="_blank">–∑–¥–µ—Å—å</a>.<br>
      –ò—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥: <a href="https://github.com/hyperion-cs/dpi-checkers" target="_blank">dpi-checkers</a>.
    </div>
  </div>

  <script>
    const OK_THRESHOLD_BYTES = 64 * 1024;
    let TIMEOUT_MS = 5000;

    const makeTest = (id, provider, host, path = "/", group) => ({
      id,
      provider,
      group,
      url: `https://${host}${path}`
    });

    // ----- –°–¢–ê–ù–î–ê–†–¢–ù–´–ï –¢–ï–°–¢–´ -----
    const gamesList = [
      "cdn.cookielaw.org/scripttemplates/202501.2.0/otBannerSdk.js",
      "genshin.jmp.blue/characters/all#",
      "api.frankfurter.dev/v1/2000-01-01..2002-12-31",
      "genderize.io/",
      "j.dejure.org/jcg/doctrine/doctrine_banner.webp",
      "tcp1620-01.dubybot.live/1MB.bin",
      "tcp1620-02.dubybot.live/1MB.bin",
      "tcp1620-05.dubybot.live/1MB.bin",
      "tcp1620-06.dubybot.live/1MB.bin",
      "eu.api.ovh.com/console/rapidoc-min.js",
      "ovh.sfx.ovh/10M.bin",
      "oracle.sfx.ovh/10M.bin",
      "tms.delta.com/delta/dl_anderson/Bootstrap.js",
      "corp.kaltura.com/wp-content/cache/min/1/wp-content/themes/airfleet/dist/styles/theme.css",
      "api.usercentrics.eu/gvl/v3/en.json",
      "openoffice.apache.org/images/blog/rejected.png",
      "www.juniper.net/etc.clientlibs/juniper/clientlibs/clientlib-site/resources/fonts/lato/Lato-Regular.woff2",
      "www.lg.com/lg5-common-gp/library/jquery.min.js",
      "media-assets.stryker.com/is/image/stryker/gateway_1?$max_width_1410$",
      "www.winkgo.com/wp-content/themes/mts_sociallyviral/fonts/fontawesome-webfont.woff2",
      "cloudlets.io/wp-content/themes/Avada/includes/lib/assets/fonts/fontawesome/webfonts/fa-solid-900.woff2",
      "renklisigorta.com.tr/teklif-al",
      "cdn.xuansiwei.com/common/lib/font-awesome/4.7.0/fontawesome-webfont.woff2?v=4.7.0"
    ].map((full, i) => {
      const [host, ...rest] = full.split('/');
      const path = '/' + rest.join('/');
      return makeTest(`GAMES-${i+1}`, `üéÆ ${host}`, host, path, 'games');
    });

    const discordHosts = [
      "discord.com", "gateway.discord.gg", "cdn.discordapp.com", "discordapp.net",
      "discordapp.com", "discord.gg", "media.discordapp.net", "images-ext-1.discordapp.net",
      "discord.app", "discord.media", "discordcdn.com", "discord.dev", "discord.new",
      "discord.gift", "discordstatus.com", "dis.gd", "discord.co",
      "discord-attachments-uploads-prd.storage.googleapis.com"
    ];
    const discordList = discordHosts.map((host, i) => 
      makeTest(`DISC-${i+1}`, `üí¨ ${host}`, host, "/", "discord")
    );

    const youtubeHosts = [
      "cdn.cookielaw.org", "api.usercentrics.eu", "googleapis.com", "gstatic.com",
      "recaptcha-cn.net", "recaptcha.net", "botstop.com", "hcaptcha.com", "hcaptchastatus.com",
      "speedtest.net", "ooklaserver.net", "speedtest.timernet.ru", "spookla.alltelecom.ru"
    ];
    const youtubeList = youtubeHosts.map((host, i) =>
      makeTest(`GOOG-${i+1}`, `üîç ${host}`, host, "/", "youtube")
    );

    const cloudHosts = [
      "digitalocean.com","digitaloceanspaces.com","do.co","hetzner.com","hetzner.de",
      "ovh.com","ovh.net","ovhcloud.com","oraclecloud.com","oraclevcn.com",
      "amazonaws.com","s3.amazonaws.com","cloudfront.net","cloudsync-prod.s3.amazonaws.com",
      "cloudsync-prod.s3-accelerate.amazonaws.com","prod-us-east-1-starwavecloudsync.s3.amazonaws.com",
      "prod-us-west-2-starwavecloudsync.s3.amazonaws.com","prod-eu-west-1-starwavecloudsync.s3.amazonaws.com",
      "prod-eu-central-1-starwavecloudsync.s3.amazonaws.com","prod-ap-northeast-1-starwavecloudsync.s3.amazonaws.com",
      "prod-ap-southeast-1-starwavecloudsync.s3.amazonaws.com","fastly.net","fastly.com",
      "akamai.com","akamaihd.net","akamaiedge.net","akamaitechnologies.com","akamaized.net",
      "eaassets-a.akamaihd.net","epicgames-download1.akamaized.net","fastly-download.epicgames.com",
      "cdn77.com","cdn77.org","constant.com","contabo.com","contabo.org","cntb.eu",
      "scaleway.com","scw.cloud","argotunnel.com","cfargotunnel.com","cfl.re","cloudflare.com",
      "cloudflare-dns.com","cloudflare-ech.com","cloudflare-esni.com","cloudflare-gateway.com",
      "cloudflare-quic.com","cloudflare-stream.com","cloudflare-ipfs.com","cloudflare-tv.com",
      "cloudflare-access.com","cloudflare-apps.com","cloudflare-bolt.com","cloudflare-client.com",
      "cloudflare-insights.com","cloudflare-ok.com","cloudflare-partners.com","cloudflare-portal.com",
      "cloudflare-preview.com","cloudflare-resolve.com","cloudflare-ssl.com","cloudflare-status.com",
      "cloudflare-storage.com","cloudflare-test.com","cloudflare-warp.com","cloudflare.net",
      "cloudflare.tv","cloudflare.dev","cloudflare.design","cloudflare.network","cloudflare.cloud",
      "cloudflare.co","cloudflare.us","cloudflare.lol","cloudflare.blog","cloudflarecp.com",
      "cloudflareaccess.com","cloudflareapps.com","cloudflarebolt.com","cloudflareclient.com",
      "cloudflareinsights.com","cloudflareok.com","cloudflarepartners.com","cloudflareportal.com",
      "cloudflarepreview.com","cloudflareresolve.com","cloudflaressl.com","cloudflarestatus.com",
      "cloudflarestorage.com","cloudflarestream.com","cloudflaretest.com","cloudflarewarp.com",
      "cloudflareregistrar.com","cloudflareregistry.com","cloudflarechallenge.com","cloudflareworkers.com",
      "cloudflareanycast.net","cloudflarechina.cn","cloudflareglobal.net","cloudflareinsights-cn.com",
      "cloudflareperf.com","cloudflareprod.com","cloudflarestaging.com","every1dns.net","isbgpsafeyet.com",
      "one.one.one.one","pacloudflare.com","pages.dev","trycloudflare.com","videodelivery.net",
      "warp.plus","workers.dev","wsrv.nl","as13335.net","cfdata-staging.org","cfplat.com","cfops.it",
      "cfops.net","cfssl.com","cfssl.org","cfdata.com","cfdata.org","cfdata.lol","cf-ipfs.com",
      "cfworker-ipfs.com","cf-test.com","cf-test-access.com","cf-ns.com","cf-ns.net","cf-ns.site",
      "cf-ns.tech","cftest5.cn","cftest6.cn","cftest7.com","cftest8.com","cflare.co","cf-emailsecurity.net",
      "cloudflare-cn.com","cloudflarechina.cn","cloudflarecn.net","cloudflareinsights-cn.com",
      "cloudflarestoragegw.com","static-cloudflare.top"
    ];
    const cloudList = cloudHosts.map((host, i) =>
      makeTest(`CLOUD-${i+1}`, `‚òÅÔ∏è ${host}`, host, "/", "cloud")
    );

    let customCounter = 0;
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Ç–µ—Å—Ç—ã –∏–∑ localStorage
    const customList = [];
    for (let i = 1; ; i++) {
      const item = localStorage.getItem(`custom-test-${i}`);
      if (!item) break;
      try {
        const test = JSON.parse(item);
        customList.push(test);
        customCounter = i;
      } catch (e) {}
    }

    const TEST_SUITE = [...gamesList, ...discordList, ...youtubeList, ...cloudList, ...customList];
    const groups = {
      games: gamesList,
      discord: discordList,
      youtube: youtubeList,
      cloud: cloudList,
      custom: customList
    };

    // DOM
    const startButton = document.getElementById("start");
    const statusEl = document.getElementById("status");
    const log = document.getElementById("log");
    const results = document.getElementById("results");
    const httpCodes = {};

    // –í–∫–ª–∞–¥–∫–∏ (—Å –¥–≤–æ–π–Ω—ã–º –∫–ª–∏–∫–æ–º)
    let lastClickTime = 0;
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const now = Date.now();
        const tabId = btn.dataset.tab;
        const isDouble = (now - lastClickTime < 400);
        lastClickTime = now;

        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(`tab-${tabId}`).classList.add('active');
        localStorage.setItem('activeTab', tabId);

        if (isDouble && tabId !== 'custom') {
          TEST_SUITE.forEach(t => localStorage.setItem(`test-${t.id}`, 'false'));
          groups[tabId].forEach(t => localStorage.setItem(`test-${t.id}`, 'true'));
          renderAllLists();
        }
      });
    });

    // –ö–Ω–æ–ø–∫–∏
    document.getElementById('select-all').addEventListener('click', () => {
      TEST_SUITE.forEach(t => localStorage.setItem(`test-${t.id}`, 'true'));
      renderAllLists();
    });

    document.getElementById('deselect-all').addEventListener('click', () => {
      TEST_SUITE.forEach(t => localStorage.setItem(`test-${t.id}`, 'false'));
      renderAllLists();
    });

    // –°–≤–æ–∏ —Å–µ—Ä–≤–µ—Ä—ã
    document.getElementById('add-custom').addEventListener('click', () => {
      const input = document.getElementById('custom-input').value.trim();
      if (!input) return;

      // –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª–∏: –∑–∞–ø—è—Ç–∞—è, –¥–≤–æ–µ—Ç–æ—á–∏–µ, –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
      const rawEntries = input.split(/[,:\n]+/).map(s => s.trim()).filter(s => s);

      const newTests = [];
      rawEntries.forEach(entry => {
        try {
          let urlObj;
          if (entry.startsWith('http://') || entry.startsWith('https://')) {
            urlObj = new URL(entry);
          } else {
            urlObj = new URL('https://' + entry);
          }
          const host = urlObj.hostname;
          const path = urlObj.pathname === '/' ? (host.includes('dubybot.live') ? '/1MB.bin' : '/') : urlObj.pathname;
          customCounter++;
          const test = makeTest(`CUSTOM-${customCounter}`, `üîß ${host}`, host, path, 'custom');
          newTests.push(test);
          localStorage.setItem(`custom-test-${customCounter}`, JSON.stringify(test));
        } catch (e) {
          logPush('WARN', 'CUSTOM', `–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL: ${entry}`);
        }
      });

      if (newTests.length > 0) {
        groups.custom.push(...newTests);
        TEST_SUITE.push(...newTests);
        renderAllLists();
        document.getElementById('custom-input').value = '';
        logPush('INFO', 'CUSTOM', `–î–æ–±–∞–≤–ª–µ–Ω–æ ${newTests.length} —Å–µ—Ä–≤–µ—Ä–æ–≤.`);
      }
    });

    document.getElementById('clear-custom').addEventListener('click', () => {
      if (!confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Ä–≤–µ—Ä—ã?')) return;
      // –£–¥–∞–ª—è–µ–º –∏–∑ localStorage
      let i = 1;
      while (localStorage.getItem(`custom-test-${i}`)) {
        localStorage.removeItem(`custom-test-${i}`);
        i++;
      }
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      groups.custom.length = 0;
      // –û–±–Ω–æ–≤–ª—è–µ–º TEST_SUITE (–ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º)
      const fixedSuite = [...gamesList, ...discordList, ...youtubeList, ...cloudList];
      Object.assign(TEST_SUITE, fixedSuite);
      renderAllLists();
      logPush('INFO', 'CUSTOM', '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Ä–≤–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã.');
    });

    // –†–µ–Ω–¥–µ—Ä
    function renderCheckboxes(containerId, tests) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      tests.forEach(test => {
        const div = document.createElement('div');
        div.className = 'server-item';
        const input = document.createElement('input');
        input.type = 'checkbox';
        input.id = `chk-${test.id}`;
        input.dataset.testId = test.id;
        input.checked = localStorage.getItem(`test-${test.id}`) === 'true';
        input.addEventListener('change', () => {
          localStorage.setItem(`test-${test.id}`, input.checked ? 'true' : 'false');
        });
        const label = document.createElement('label');
        label.htmlFor = `chk-${test.id}`;
        label.textContent = test.provider;
        div.appendChild(input);
        div.appendChild(label);
        container.appendChild(div);
      });
    }

    function renderAllLists() {
      Object.entries(groups).forEach(([key, tests]) => {
        renderCheckboxes(`list-${key}`, tests);
      });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞
    const savedTab = localStorage.getItem('activeTab') || 'games';
    document.querySelectorAll('.tab-btn').forEach(btn => {
      if (btn.dataset.tab === savedTab) {
        btn.click();
      }
    });
    renderAllLists();

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
    function getSelectedTests() {
      return TEST_SUITE.filter(test => localStorage.getItem(`test-${test.id}`) === 'true');
    }

    // UI
    const toggleUI = (locked) => {
      startButton.disabled = locked;
      startButton.textContent = locked ? "–ü—Ä–æ–≤–µ—Ä–∫–∞..." : "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É";
      statusEl.className = locked ? "status-checking" : "status-ready";
    };

    const setStatus = (col, text, cls) => {
      col.textContent = text;
      col.className = cls;
      if (cls === "bad") statusEl.className = "status-error";
    };

    const logPush = (level, prefix, msg) => {
      const now = new Date();
      const ts = now.toLocaleTimeString([], { hour12: false }) + "." + now.getMilliseconds().toString().padStart(3, "0");
      log.textContent += `[${ts}] ${prefix ? prefix + "/" : ""}${level}: ${msg}\n`;
      log.scrollTop = log.scrollHeight;
    };

    const timeElapsed = t0 => `${(performance.now() - t0).toFixed(1)} –º—Å`;

    const getHttpStatus = id => httpCodes[id];

    const getUniqueUrl = url => {
      return url.includes('?') ? `${url}&t=${Math.random()}` : `${url}?t=${Math.random()}`;
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞
    const startOrchestrator = async () => {
      statusEl.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞ ‚è∞";
      statusEl.className = "status-checking";
      while (results.rows.length > 1) results.deleteRow(1);

      const selected = getSelectedTests();
      if (selected.length === 0) {
        logPush("WARN", null, "–ù–µ—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤.");
        statusEl.textContent = "–ì–æ—Ç–æ–≤ ‚ö°";
        statusEl.className = "status-ready";
        toggleUI(false);
        return;
      }

      try {
        const tasks = selected.map(t => checkDpi(t.id, t.provider, t.url));
        await Promise.all(tasks);
        statusEl.textContent = "–ì–æ—Ç–æ–≤ ‚ö°";
        statusEl.className = "status-ready";
      } catch (e) {
        statusEl.textContent = "–û—à–∏–±–∫–∞ ‚ö†Ô∏è";
        logPush("ERR", null, `–û—à–∏–±–∫–∞: ${e}`);
        statusEl.className = "status-error";
      }
      logPush("INFO", null, "–ì–æ—Ç–æ–≤–æ.");
      toggleUI(false);
    };

    const checkDpi = async (id, provider, url) => {
      const prefix = `DPI(#${id})`;
      const t0 = performance.now();
      const ctrl = new AbortController();
      const timeoutId = setTimeout(() => ctrl.abort(), TIMEOUT_MS);
      const row = results.insertRow();
      const numCell = row.insertCell();
      const providerCell = row.insertCell();
      const statusCell = row.insertCell();
      numCell.textContent = id;
      providerCell.textContent = provider;
      setStatus(statusCell, "–ü—Ä–æ–≤–µ—Ä–∫–∞ ‚è∞", "");

      try {
        const r = await fetch(getUniqueUrl(url), {
          method: "GET",
          credentials: "omit",
          cache: "no-store",
          signal: ctrl.signal,
          redirect: "manual",
          keepalive: true
        });
        logPush("INFO", prefix, `HTTP ${r.status}`);
        httpCodes[id] = r.status;
        const reader = r.body.getReader();
        let received = 0, ok = false;
        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            clearTimeout(timeoutId);
            if (!ok) {
              setStatus(statusCell, "–í–æ–∑–º–æ–∂–Ω–æ, –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚ö†Ô∏è", "");
            }
            break;
          }
          received += value.byteLength;
          if (!ok && received >= OK_THRESHOLD_BYTES) {
            clearTimeout(timeoutId);
            await reader.cancel();
            ok = true;
            logPush("INFO", prefix, `–ü–æ—Ä–æ–≥ –ø—Ä–æ–π–¥–µ–Ω (${timeElapsed(t0)})`);
            setStatus(statusCell, "–ù–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è ‚úÖ", "ok");
            break;
          }
        }
      } catch (e) {
        clearTimeout(timeoutId);
        if (e.name === "AbortError") {
          const statusCode = getHttpStatus(id);
          setStatus(statusCell, statusCode ? "–ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è! ‚ùóÔ∏è" : "–ë–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è* ‚ùóÔ∏è", "bad");
          logPush("ERR", prefix, `–¢–∞–π–º–∞—É—Ç (${timeElapsed(t0)})`);
        } else {
          logPush("ERR", prefix, `–û—à–∏–±–∫–∞: ${e}`);
          setStatus(statusCell, "–û—à–∏–±–∫–∞ ‚ö†Ô∏è", "");
        }
      }
    };

    startButton.onclick = () => {
      log.textContent = "";
      toggleUI(true);
      startOrchestrator();
    };

    // ASN
    const fetchAsn = async () => {
      try {
        const RIPE_API_URL = "https://stat.ripe.net/data/";
        const ip = (await (await fetch(RIPE_API_URL + "whats-my-ip/data.json")).json()).data.ip;
        const asn = (await (await fetch(RIPE_API_URL + "prefix-overview/data.json?resource=" + ip)).json()).data.asns[0];
        const geo = (await (await fetch(RIPE_API_URL + "maxmind-geo-lite/data.json?resource=" + ip)).json()).data.located_resources[0].locations[0];
        const el = document.getElementById("asn");
        el.innerHTML = `ASN: <a href="https://bgp.he.net/AS${asn.asn}" target="_blank">AS${asn.asn}</a> (<i>${asn.holder}</i>) ‚Ä¢ ${geo.country}, ${geo.city || "‚Äî"}`;
      } catch (err) {
        console.error("ASN error:", err);
      }
    };

    document.addEventListener("DOMContentLoaded", fetchAsn);
  </script>
</body>
</html>
